<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Liquid Glass Slides - Ù…Ø­Ø±Ø± Ø´Ø±Ø§Ø¦Ø­ Ù…ØªÙ‚Ø¯Ù…</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg0:#070A0F;
      --bg1:#06121A;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.18);
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --text:#E9EEF7;
      --muted: rgba(233,238,247,.72);
      --accent:#00BF63;
      --danger:#ff4d4d;
      --radius: 22px;
    }

    *{box-sizing:border-box; letter-spacing: 0 !important;}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      direction: rtl;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      font-feature-settings: "liga" 1, "calt" 1;
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(0,191,99,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 25%, rgba(0,140,255,.12), transparent 60%),
        radial-gradient(800px 700px at 60% 90%, rgba(255,140,0,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: var(--radius);
    }

    .app{
      height:100%;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:14px;
      padding:16px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logoDot{
      width:14px;height:14px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 22px rgba(0,191,99,.55);
    }
    .brand h1{font-size:16px;margin:0;font-weight:800;}
    .brand small{display:block;color:var(--muted);font-weight:500;margin-top:2px}

    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
      backdrop-filter: blur(12px);
    }
    button:hover{background: rgba(255,255,255,.12)}
    button:active{transform: scale(.98)}
    .btnAccent{border-color: rgba(0,191,99,.5)}
    .btnDanger{border-color: rgba(255,77,77,.45)}
    .btnGhost{background: rgba(255,255,255,.04)}
    .btnSmall{padding:6px 10px;font-size:12px;border-radius:10px}

    main{
      display:grid;
      grid-template-columns: 1fr 480px;
      gap:14px;
      min-height:0;
    }

    .stage{
      position:relative;
      padding:14px;
      min-height:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:auto;
    }
    .slideWrap{
      padding:24px;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .pdfPageBg{
      position:absolute;
      inset:0;
      border-radius: 16px;
      overflow:hidden;
    }

    .slide{
      width: 720px;
      min-height: 400px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.20);
      backdrop-filter: blur(14px);
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      padding:42px 50px;
      overflow:hidden;
      position:relative;
    }
    .slide::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      pointer-events:none;
      border-radius: 22px;
    }
    .slide::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 220px at 30% 0%, rgba(255,255,255,.20), transparent 55%);
      pointer-events:none;
      opacity:.7;
    }

    .slideHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      position:relative;
      z-index:1;
    }
    .slideTitle{
      font-size: var(--title-size, 42px);
      line-height:1.12;
      margin:0;
      font-weight:900;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .slideMeta{
      text-align:left;
      color:rgba(233,238,247,.78);
      font-weight:700;
      font-size: var(--meta-size, 14px);
      white-space:nowrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      font-size: var(--chip-size, 14px);
      margin-top:10px;
    }
    .chipDot{
      width:8px;height:8px;border-radius:999px;background:var(--accent);
      box-shadow: 0 0 18px rgba(0,191,99,.55);
    }

    .slideBody{
      margin-top:26px;
      font-size: var(--body-size, 20px);
      line-height:1.75;
      color:rgba(233,238,247,.92);
      position:relative;
      z-index:1;
      white-space:pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .slideFooter{
      position:absolute;
      bottom:22px;
      left:26px;
      right:26px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:rgba(233,238,247,.62);
      font-weight:700;
      font-size: var(--meta-size, 14px);
      z-index:1;
    }

    /* Template Specific Styles */
    .slideImage{
      width:100%;
      max-height:300px;
      object-fit:cover;
      border-radius:16px;
      margin:20px 0;
      position:relative;
      z-index:1;
    }
    .slideVideo{
      width:100%;
      max-height:300px;
      border-radius:16px;
      margin:20px 0;
      position:relative;
      z-index:1;
      background:#000;
    }
    .slideTable{
      width:100%;
      border-collapse:collapse;
      margin:20px 0;
      position:relative;
      z-index:1;
    }
    .slideTable th, .slideTable td{
      padding:12px 16px;
      border:1px solid rgba(255,255,255,.15);
      text-align:right;
    }
    .slideTable th{
      background:rgba(0,191,99,.15);
      font-weight:800;
    }
    .slideTable tr:nth-child(even){
      background:rgba(255,255,255,.03);
    }
    .slideChart{
      width:100%;
      height:280px;
      margin:20px 0;
      position:relative;
      z-index:1;
    }
    .introContent{
      text-align:center;
      padding:40px 0;
    }
    .introContent .slideTitle{
      font-size:52px;
      margin-bottom:20px;
    }
    .introContent .subtitle{
      font-size:24px;
      color:var(--muted);
      margin-bottom:30px;
    }
    .introContent .authorInfo{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:16px;
      margin-top:30px;
    }
    .introContent .authorAvatar{
      width:60px;height:60px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--accent);
    }
    .outroContent{
      text-align:center;
      padding:60px 0;
    }
    .outroContent .thankYou{
      font-size:48px;
      font-weight:900;
      margin-bottom:20px;
    }
    .outroContent .contactInfo{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:30px;
    }
    .outroContent .contactItem{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color:var(--muted);
    }
    .tocContent{
      padding:20px 0;
    }
    .tocItem{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px dashed rgba(255,255,255,.15);
    }
    .tocItem:last-child{border-bottom:none}
    .tocDots{
      flex:1;
      border-bottom:2px dotted rgba(255,255,255,.2);
      margin:0 10px;
    }
    .quoteContent{
      text-align:center;
      padding:40px 20px;
    }
    .quoteText{
      font-size:28px;
      font-style:italic;
      line-height:1.6;
      color:rgba(233,238,247,.9);
      position:relative;
    }
    .quoteText::before{
      content:'"';
      font-size:80px;
      position:absolute;
      top:-30px;
      right:-20px;
      color:var(--accent);
      opacity:.3;
    }
    .quoteAuthor{
      margin-top:20px;
      color:var(--accent);
      font-weight:700;
    }
    .splitLayout{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:30px;
      margin-top:20px;
    }
    .splitLayout.reverse{
      direction:ltr;
    }
    .splitLayout img{
      width:100%;
      height:200px;
      object-fit:cover;
      border-radius:16px;
    }
    .bulletList{
      list-style:none;
      padding:0;
      margin:20px 0;
    }
    .bulletList li{
      padding:12px 0;
      padding-right:30px;
      position:relative;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .bulletList li::before{
      content:'';
      position:absolute;
      right:0;
      top:18px;
      width:10px;height:10px;
      background:var(--accent);
      border-radius:50%;
    }
    .statGrid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:20px;
      margin:30px 0;
    }
    .statItem{
      text-align:center;
      padding:20px;
      background:rgba(255,255,255,.05);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.1);
    }
    .statNumber{
      font-size:36px;
      font-weight:900;
      color:var(--accent);
    }
    .statLabel{
      font-size:14px;
      color:var(--muted);
      margin-top:8px;
    }
    .timelineItem{
      display:flex;
      gap:20px;
      padding:20px 0;
      border-right:3px solid var(--accent);
      padding-right:20px;
      margin-right:10px;
    }
    .timelineDate{
      font-weight:800;
      color:var(--accent);
      min-width:80px;
    }
    .comparisonGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin:20px 0;
    }
    .comparisonItem{
      padding:20px;
      border-radius:16px;
      background:rgba(255,255,255,.05);
    }
    .comparisonItem.pros{border:1px solid rgba(0,191,99,.3)}
    .comparisonItem.cons{border:1px solid rgba(255,77,77,.3)}
    .comparisonTitle{
      font-weight:800;
      margin-bottom:12px;
    }
    .comparisonItem.pros .comparisonTitle{color:var(--accent)}
    .comparisonItem.cons .comparisonTitle{color:var(--danger)}

    /* Panel Styles */
    .panel{
      min-height:0;
      max-height:100%;
      padding:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .panelContent{
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .panelContent::-webkit-scrollbar{width:8px}
    .panelContent::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:10px}
    .panelContent::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:10px}
    .panelFooter{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.1);
      background:rgba(0,0,0,.2);
    }
    .panel h3{
      margin:8px 2px 4px;
      font-size:13px;
      color:rgba(0,191,99,.9);
      font-weight:800;
      border-bottom:1px solid rgba(255,255,255,.1);
      padding-bottom:6px;
      cursor:pointer;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:12px;
      color:rgba(233,238,247,.75);
      font-weight:800;
    }
    input, textarea, select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px;
      outline:none;
      font-family: inherit;
      font-weight:700;
      font-size:13px;
    }
    select{cursor:pointer}
    input[type="color"]{padding:4px;height:38px;cursor:pointer}
    input[type="range"]{
      padding:0;height:6px;cursor:pointer;
      -webkit-appearance:none;
      background: rgba(255,255,255,.15);
      border-radius:10px;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:16px;height:16px;
      background:var(--accent);
      border-radius:50%;
      cursor:pointer;
    }
    textarea{
      min-height:100px;
      resize:vertical;
      line-height:1.6;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row > *{flex:1;min-width:0}

    .templateSelector{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
      margin-bottom:12px;
    }
    .templateBtn{
      padding:12px 8px;
      border-radius:12px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.1);
      cursor:pointer;
      text-align:center;
      transition:all .2s;
      font-size:11px;
    }
    .templateBtn:hover{background:rgba(255,255,255,.08)}
    .templateBtn.active{
      border-color:var(--accent);
      background:rgba(0,191,99,.1);
    }
    .templateBtn .icon{font-size:20px;display:block;margin-bottom:4px}

    .collapsible::before{content:"â–¼";font-size:10px;margin-left:6px;transition:transform .2s}
    .collapsible.collapsed::before{transform:rotate(-90deg)}
    .collapsibleContent{transition:max-height .3s}
    .collapsibleContent.collapsed{max-height:0 !important;padding:0;margin:0}

    .dataRow{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
      background:rgba(255,255,255,.03);
      padding:8px;
      border-radius:8px;
    }
    .dataRow input{flex:1}
    .dataRow .btnSmall{flex-shrink:0}

    footer{
      padding:12px;
      display:flex;
      gap:10px;
      overflow:auto;
      align-items:center;
    }
    .thumb{
      width:140px;
      min-width:140px;
      aspect-ratio:16/9;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      padding:8px;
      cursor:pointer;
      position:relative;
      transition:all .15s;
    }
    .thumb:hover{background:rgba(255,255,255,.10)}
    .thumb.active{
      border-color:rgba(0,191,99,.55);
      box-shadow:0 0 0 2px rgba(0,191,99,.18) inset;
    }
    .thumbTitle{
      font-size:10px;
      font-weight:800;
      line-height:1.2;
      max-height:24px;
      overflow:hidden;
    }
    .thumbType{
      position:absolute;
      top:4px;left:4px;
      font-size:9px;
      padding:3px 6px;
      background:rgba(0,191,99,.2);
      border-radius:6px;
      color:var(--accent);
    }
    .thumbIndex{
      position:absolute;
      top:4px;right:4px;
      font-size:10px;
      padding:3px 7px;
      background:rgba(0,0,0,.4);
      border-radius:6px;
    }

    @media(max-width:1100px){
      main{grid-template-columns:1fr}
      .panel{order:-1;max-height:400px}
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="glass">
      <div class="brand">
        <span class="logoDot"></span>
        <div>
          <h1>Liquid Glass Slides</h1>
          <small>Ù…Ø­Ø±Ù‘Ø± Ø´Ø±Ø§Ø¦Ø­ Ù…ØªÙ‚Ø¯Ù… â€” Ù‚ÙˆØ§Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯Ø©</small>
        </div>
      </div>
      <div class="toolbar">
        <button class="btnGhost" id="btnNew">+ Ø´Ø±ÙŠØ­Ø©</button>
        <button class="btnGhost" id="btnDup">Ù†Ø³Ø®</button>
        <button class="btnDanger" id="btnDel">Ø­Ø°Ù</button>
        <button class="btnGhost" id="btnSaveProject">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btnGhost" id="btnLoadProject">ğŸ“‚ ÙØªØ­</button>
        <button class="btnAccent" id="btnExport">ØªØµØ¯ÙŠØ± PDF</button>
        <input type="file" id="fileInput" accept=".lgs,.json" style="display:none" />
      </div>
    </header>

    <main>
      <section class="stage glass">
        <div class="slideWrap" id="exportWrapper">
          <div class="pdfPageBg" id="pdfPageBg"></div>
          <div class="slide" id="slideExportRoot"></div>
        </div>
      </section>

      <aside class="panel glass">
        <div class="panelContent">
          <!-- Template Selection -->
          <h3 class="collapsible" data-target="templateSection">ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Ù„Ø¨</h3>
          <div class="collapsibleContent" id="templateSection">
            <div class="templateSelector" id="templateSelector"></div>
          </div>

          <!-- Content Section -->
          <h3 class="collapsible" data-target="contentSection">ğŸ“ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±ÙŠØ­Ø©</h3>
          <div class="collapsibleContent" id="contentSection">
            <div id="templateFields"></div>
          </div>

          <!-- Card Size -->
          <h3 class="collapsible" data-target="cardSizeSection">ğŸ“ Ø­Ø¬Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
          <div class="collapsibleContent" id="cardSizeSection">
            <div class="field">
              <label>Ø§Ù„Ø­Ø¬Ù…</label>
              <select id="cardSizePreset">
                <option value="small">ØµØºÙŠØ± (540px)</option>
                <option value="medium" selected>Ù…ØªÙˆØ³Ø· (720px)</option>
                <option value="large">ÙƒØ¨ÙŠØ± (900px)</option>
                <option value="xlarge">ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (1080px)</option>
                <option value="custom">Ù…Ø®ØµØµ</option>
              </select>
            </div>
            <div id="cardCustomSizeOptions" style="display:none">
              <div class="row">
                <div class="field">
                  <label>Ø§Ù„Ø¹Ø±Ø¶ (px)</label>
                  <input type="number" id="cardCustomWidth" value="720" min="300" max="1920" />
                </div>
                <div class="field">
                  <label>Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (px)</label>
                  <input type="number" id="cardCustomHeight" value="450" min="200" max="1080" />
                </div>
              </div>
            </div>
            <div class="field">
              <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</label>
              <select id="cardAspectRatio">
                <option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰)</option>
                <option value="16:9">16:9 Ø¹Ø±ÙŠØ¶</option>
                <option value="4:3">4:3 ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</option>
                <option value="1:1">1:1 Ù…Ø±Ø¨Ø¹</option>
                <option value="3:4">3:4 Ø¨ÙˆØ±ØªØ±ÙŠÙ‡</option>
                <option value="9:16">9:16 Ø³ØªÙˆØ±ÙŠ</option>
              </select>
            </div>
            <div class="field">
              <label>Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
              <div class="row" style="align-items:center">
                <input type="range" id="cardContentScale" min="50" max="150" value="100" />
                <span id="cardContentScaleValue" style="min-width:40px;text-align:center">100%</span>
              </div>
            </div>
          </div>

          <!-- Card Background -->
          <h3 class="collapsible" data-target="cardBgSection">ğŸ¨ Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
          <div class="collapsibleContent" id="cardBgSection">
            <div class="field">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
              <select id="cardBgType">
                <option value="gradient">ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ</option>
                <option value="solid">Ù„ÙˆÙ† Ø«Ø§Ø¨Øª</option>
                <option value="image">ØµÙˆØ±Ø©</option>
              </select>
            </div>
            <div id="cardGradientOptions">
              <div class="field">
                <label>Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªØ¯Ø±Ø¬</label>
                <div class="row">
                  <input type="color" id="cardGradient1" value="#0a0f1a" />
                  <input type="color" id="cardGradient2" value="#0d1520" />
                </div>
              </div>
            </div>
            <div id="cardSolidOptions" style="display:none">
              <div class="field">
                <label>Ø§Ù„Ù„ÙˆÙ†</label>
                <input type="color" id="cardSolidColor" value="#0a1015" />
              </div>
            </div>
            <div id="cardImageOptions" style="display:none">
              <div class="field">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label>
                <input id="cardImageUrl" placeholder="https://..." />
              </div>
            </div>

            <h3 class="collapsible" data-target="glowsSection" style="margin-top:12px">âœ¨ Ø§Ù„ØªÙˆÙ‡Ø¬Ø§Øª</h3>
            <div class="collapsibleContent" id="glowsSection">
              <div id="glowsList"></div>
              <button class="btnGhost btnSmall" id="btnAddGlow">+ Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‡Ø¬</button>
            </div>
          </div>

          <!-- Page Settings -->
          <h3 class="collapsible" data-target="pageSection">ğŸ“„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©</h3>
          <div class="collapsibleContent" id="pageSection">
            <div class="field">
              <label>Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©</label>
              <select id="pageFormat">
                <option value="16:9">Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠ (16:9)</option>
                <option value="1:1">Ù…Ø±Ø¨Ø¹ - Instagram (1:1)</option>
                <option value="4:5">Ø¨ÙˆØ±ØªØ±ÙŠÙ‡ - Instagram (4:5)</option>
                <option value="9:16">Ø³ØªÙˆØ±ÙŠ (9:16)</option>
                <option value="4:3">ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ (4:3)</option>
                <option value="A4">A4 Ø¹Ù…ÙˆØ¯ÙŠ</option>
                <option value="A4-L">A4 Ø£ÙÙ‚ÙŠ</option>
              </select>
            </div>
            <div class="field">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="syncBgWithCard" style="width:auto;accent-color:var(--accent)" />
                Ù…Ø·Ø§Ø¨Ù‚Ø© Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
              </label>
            </div>
            <div id="pdfCustomBgOptions">
              <div class="field">
                <label>Ù†ÙˆØ¹ Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø©</label>
                <select id="pdfBgType">
                  <option value="gradient">ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ</option>
                  <option value="solid">Ù„ÙˆÙ† Ø«Ø§Ø¨Øª</option>
                </select>
              </div>
              <div id="pdfGradientOptions">
                <div class="row">
                  <input type="color" id="pdfGradient1" value="#070a12" />
                  <input type="color" id="pdfGradient2" value="#0d1420" />
                </div>
              </div>
              <div id="pdfSolidOptions" style="display:none">
                <input type="color" id="pdfSolidColor" value="#0a0f15" />
              </div>
            </div>
          </div>
        </div>

        <div class="panelFooter">
          <div class="row">
            <button class="btnGhost" id="btnPrev">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btnGhost" id="btnNext">Ø§Ù„ØªØ§Ù„ÙŠ âœ</button>
          </div>
        </div>
      </aside>
    </main>

    <footer class="glass" id="thumbStrip"></footer>
  </div>

<script>
const $ = id => document.getElementById(id);

// Template definitions
const TEMPLATES = {
  text: {
    name: 'Ù†Øµ',
    icon: 'ğŸ“',
    fields: ['title', 'chip', 'body', 'author', 'footerLeft', 'footerRight'],
    defaults: { title: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙŠØ­Ø©', chip: 'Ø³Ù„Ø³Ù„Ø© Â· 01', body: 'Ø§ÙƒØªØ¨ Ù†ØµÙƒ Ù‡Ù†Ø§...', author: 'Yazeed', footerLeft: 'yazeed.site', footerRight: '' }
  },
  image: {
    name: 'ØµÙˆØ±Ø©',
    icon: 'ğŸ–¼ï¸',
    fields: ['title', 'imageUrl', 'caption', 'author'],
    defaults: { title: 'ØµÙˆØ±Ø©', imageUrl: '', caption: '', author: 'Yazeed' }
  },
  textImage: {
    name: 'Ù†Øµ + ØµÙˆØ±Ø©',
    icon: 'ğŸ“„',
    fields: ['title', 'body', 'imageUrl', 'imagePosition', 'author'],
    defaults: { title: 'Ø¹Ù†ÙˆØ§Ù†', body: 'Ø§Ù„Ù†Øµ Ù‡Ù†Ø§...', imageUrl: '', imagePosition: 'bottom', author: 'Yazeed' }
  },
  table: {
    name: 'Ø¬Ø¯ÙˆÙ„',
    icon: 'ğŸ“Š',
    fields: ['title', 'tableHeaders', 'tableRows', 'author'],
    defaults: { title: 'Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª', tableHeaders: ['Ø§Ù„Ø¹Ù…ÙˆØ¯ 1', 'Ø§Ù„Ø¹Ù…ÙˆØ¯ 2', 'Ø§Ù„Ø¹Ù…ÙˆØ¯ 3'], tableRows: [['Ø¨ÙŠØ§Ù†Ø§Øª', 'Ø¨ÙŠØ§Ù†Ø§Øª', 'Ø¨ÙŠØ§Ù†Ø§Øª']], author: 'Yazeed' }
  },
  chart: {
    name: 'Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ',
    icon: 'ğŸ“ˆ',
    fields: ['title', 'chartType', 'chartLabels', 'chartData', 'author'],
    defaults: { title: 'Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ', chartType: 'bar', chartLabels: ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯'], chartData: [25, 45, 30, 50], author: 'Yazeed' }
  },
  multiChart: {
    name: 'Ø±Ø³ÙˆÙ… Ù…ØªØ¹Ø¯Ø¯Ø©',
    icon: 'ğŸ“Š',
    fields: ['title', 'multiChartMode', 'chartLabels', 'chartDatasets', 'author'],
    defaults: { 
      title: 'Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø©', 
      multiChartMode: 'overlay', 
      chartLabels: ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯'], 
      chartDatasets: [
        { type: 'bar', label: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰', data: [25, 45, 30, 50], color: '#00bf63' },
        { type: 'line', label: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ©', data: [40, 30, 45, 35], color: '#008cff' }
      ],
      author: 'Yazeed' 
    }
  },
  intro: {
    name: 'Ù…Ù‚Ø¯Ù…Ø©',
    icon: 'ğŸ¬',
    fields: ['title', 'subtitle', 'authorName', 'authorTitle', 'authorAvatar', 'date'],
    defaults: { title: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶', subtitle: 'Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø®ØªØµØ±', authorName: 'ÙŠØ²ÙŠØ¯ Ø§Ù„Ø£Ø³Ù…Ø±ÙŠ', authorTitle: 'Ù…Ø·ÙˆØ± ÙˆÙŠØ¨', authorAvatar: '', date: new Date().toLocaleDateString('ar') }
  },
  outro: {
    name: 'Ø®Ø§ØªÙ…Ø©',
    icon: 'ğŸ¯',
    fields: ['thankYouText', 'email', 'website', 'social'],
    defaults: { thankYouText: 'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ…', email: 'email@example.com', website: 'example.com', social: '@username' }
  },
  toc: {
    name: 'ÙÙ‡Ø±Ø³',
    icon: 'ğŸ“‘',
    fields: ['title', 'tocItems'],
    defaults: { title: 'ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª', tocItems: [{ text: 'Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©', page: '01' }, { text: 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„', page: '02' }] }
  },
  video: {
    name: 'ÙÙŠØ¯ÙŠÙˆ',
    icon: 'ğŸ¥',
    fields: ['title', 'videoUrl', 'videoType', 'caption', 'author'],
    defaults: { title: 'ÙÙŠØ¯ÙŠÙˆ', videoUrl: '', videoType: 'youtube', caption: '', author: 'Yazeed' }
  },
  quote: {
    name: 'Ø§Ù‚ØªØ¨Ø§Ø³',
    icon: 'ğŸ’¬',
    fields: ['quoteText', 'quoteAuthor', 'author'],
    defaults: { quoteText: 'Ù†Øµ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ù‡Ù†Ø§...', quoteAuthor: 'Ø§Ù„Ù…ØµØ¯Ø±', author: 'Yazeed' }
  },
  bullets: {
    name: 'Ù†Ù‚Ø§Ø·',
    icon: 'ğŸ“Œ',
    fields: ['title', 'bulletItems', 'author'],
    defaults: { title: 'Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', bulletItems: ['Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©', 'Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©'], author: 'Yazeed' }
  },
  stats: {
    name: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
    icon: 'ğŸ“Š',
    fields: ['title', 'stats', 'author'],
    defaults: { title: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', stats: [{ number: '100+', label: 'Ù…Ø´Ø±ÙˆØ¹' }, { number: '50K', label: 'Ù…Ø³ØªØ®Ø¯Ù…' }, { number: '99%', label: 'Ø±Ø¶Ø§' }], author: 'Yazeed' }
  },
  timeline: {
    name: 'Ø®Ø· Ø²Ù…Ù†ÙŠ',
    icon: 'ğŸ“…',
    fields: ['title', 'timelineItems', 'author'],
    defaults: { title: 'Ø§Ù„Ù…Ø±Ø§Ø­Ù„', timelineItems: [{ date: '2024', text: 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©' }, { date: '2025', text: 'Ø§Ù„ØªØ·ÙˆÙŠØ±' }], author: 'Yazeed' }
  },
  comparison: {
    name: 'Ù…Ù‚Ø§Ø±Ù†Ø©',
    icon: 'âš–ï¸',
    fields: ['title', 'prosTitle', 'prosItems', 'consTitle', 'consItems', 'author'],
    defaults: { title: 'Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©', prosTitle: 'Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª', prosItems: ['Ù…ÙŠØ²Ø© 1', 'Ù…ÙŠØ²Ø© 2'], consTitle: 'Ø§Ù„Ø¹ÙŠÙˆØ¨', consItems: ['Ø¹ÙŠØ¨ 1', 'Ø¹ÙŠØ¨ 2'], author: 'Yazeed' }
  },
  code: {
    name: 'ÙƒÙˆØ¯',
    icon: 'ğŸ’»',
    fields: ['title', 'codeLanguage', 'codeContent', 'author'],
    defaults: { title: 'Ù…Ø«Ø§Ù„ Ø¨Ø±Ù…Ø¬ÙŠ', codeLanguage: 'javascript', codeContent: 'console.log("Hello!");', author: 'Yazeed' }
  }
};

// Field definitions
const FIELD_DEFS = {
  title: { label: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', type: 'input' },
  chip: { label: 'Ø§Ù„Ø´ÙŠØ¨', type: 'input' },
  body: { label: 'Ø§Ù„Ù†Øµ', type: 'textarea' },
  author: { label: 'Ø§Ù„ÙƒØ§ØªØ¨', type: 'input' },
  footerLeft: { label: 'ÙÙˆØªØ± ÙŠØ³Ø§Ø±', type: 'input' },
  footerRight: { label: 'ÙÙˆØªØ± ÙŠÙ…ÙŠÙ†', type: 'input' },
  imageUrl: { label: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©', type: 'input', placeholder: 'https://...' },
  caption: { label: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', type: 'input' },
  imagePosition: { label: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµÙˆØ±Ø©', type: 'select', options: [['top', 'Ø£Ø¹Ù„Ù‰'], ['bottom', 'Ø£Ø³ÙÙ„'], ['left', 'ÙŠØ³Ø§Ø±'], ['right', 'ÙŠÙ…ÙŠÙ†']] },
  videoUrl: { label: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ', type: 'input', placeholder: 'YouTube Ø£Ùˆ Vimeo' },
  videoType: { label: 'Ù†ÙˆØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ', type: 'select', options: [['youtube', 'YouTube'], ['vimeo', 'Vimeo'], ['direct', 'Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±']] },
  chartType: { label: 'Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ù…', type: 'select', options: [['bar', 'Ø£Ø¹Ù…Ø¯Ø©'], ['line', 'Ø®Ø·ÙŠ'], ['pie', 'Ø¯Ø§Ø¦Ø±ÙŠ'], ['doughnut', 'Ø­Ù„Ù‚ÙŠ'], ['radar', 'Ø±Ø§Ø¯Ø§Ø±']] },
  chartLabels: { label: 'Ø§Ù„ØªØ³Ù…ÙŠØ§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)', type: 'input' },
  chartData: { label: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)', type: 'input' },
  multiChartMode: { label: 'ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶', type: 'select', options: [['overlay', 'Ù…Ø¯Ù…Ø¬ (ÙÙˆÙ‚ Ø¨Ø¹Ø¶)'], ['sideBySide', 'Ù…Ù†ÙØµÙ„ (Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶)']] },
  chartDatasets: { label: 'Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', type: 'chartDatasetsArray' },
  tableHeaders: { label: 'Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©', type: 'array' },
  tableRows: { label: 'ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„', type: 'table' },
  subtitle: { label: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ', type: 'input' },
  authorName: { label: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù', type: 'input' },
  authorTitle: { label: 'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ', type: 'input' },
  authorAvatar: { label: 'ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¤Ù„Ù', type: 'input', placeholder: 'https://...' },
  date: { label: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', type: 'input' },
  thankYouText: { label: 'Ù†Øµ Ø§Ù„Ø´ÙƒØ±', type: 'input' },
  email: { label: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', type: 'input' },
  website: { label: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹', type: 'input' },
  social: { label: 'Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ§ØµÙ„', type: 'input' },
  tocItems: { label: 'Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙ‡Ø±Ø³', type: 'tocArray' },
  quoteText: { label: 'Ù†Øµ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³', type: 'textarea' },
  quoteAuthor: { label: 'ØµØ§Ø­Ø¨ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³', type: 'input' },
  bulletItems: { label: 'Ø§Ù„Ù†Ù‚Ø§Ø·', type: 'array' },
  stats: { label: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', type: 'statsArray' },
  timelineItems: { label: 'Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ', type: 'timelineArray' },
  prosTitle: { label: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª', type: 'input' },
  prosItems: { label: 'Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª', type: 'array' },
  consTitle: { label: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹ÙŠÙˆØ¨', type: 'input' },
  consItems: { label: 'Ø§Ù„Ø¹ÙŠÙˆØ¨', type: 'array' },
  codeLanguage: { label: 'Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©', type: 'input' },
  codeContent: { label: 'Ø§Ù„ÙƒÙˆØ¯', type: 'textarea' }
};

// State
let slides = [];
let active = 0;
let bgSettings = {
  card: { type: 'gradient', gradient1: '#0a0f1a', gradient2: '#0d1520', solidColor: '#0a1015', imageUrl: '' },
  pdf: { type: 'gradient', gradient1: '#070a12', gradient2: '#0d1420', solidColor: '#0a0f15', syncWithCard: false },
  pageFormat: '16:9',
  cardSize: { preset: 'medium', width: 720, height: null, aspectRatio: 'auto', contentScale: 100 },
  glows: [
    { color: '#00bf63', x: 30, y: 20, width: 700, height: 400, opacity: 22, spread: 55 },
    { color: '#008cff', x: 85, y: 25, width: 700, height: 500, opacity: 18, spread: 55 }
  ]
};

function createSlide(template = 'text') {
  const tpl = TEMPLATES[template];
  return { template, ...JSON.parse(JSON.stringify(tpl.defaults)) };
}

function pad2(n) { return String(n).padStart(2, '0'); }

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function generateCardBackground() {
  const { card, glows } = bgSettings;
  let layers = [];
  glows.forEach(g => {
    layers.push(`radial-gradient(${g.width}px ${g.height}px at ${g.x}% ${g.y}%, ${hexToRgba(g.color, g.opacity / 100)}, transparent ${g.spread}%)`);
  });
  if (card.type === 'gradient') {
    layers.push(`linear-gradient(135deg, ${card.gradient1}, ${card.gradient2})`);
  } else if (card.type === 'solid') {
    layers.push(card.solidColor);
  } else if (card.type === 'image' && card.imageUrl) {
    layers.push(`url(${card.imageUrl})`);
  }
  return layers.join(', ');
}

function generatePdfBackground() {
  const { pdf } = bgSettings;
  if (pdf.syncWithCard) return generateCardBackground();
  if (pdf.type === 'gradient') return `linear-gradient(135deg, ${pdf.gradient1}, ${pdf.gradient2})`;
  return pdf.solidColor;
}

function applyBackgrounds() {
  $('slideExportRoot').style.background = generateCardBackground();
  $('pdfPageBg').style.background = generatePdfBackground();
}

function updateSlideWrapSize() {
  const wrapper = $('exportWrapper');
  const slide = $('slideExportRoot');
  const formats = {
    '16:9': 16/9, '1:1': 1, '4:5': 4/5, '9:16': 9/16,
    '4:3': 4/3, 'A4': 210/297, 'A4-L': 297/210
  };
  const ratio = formats[bgSettings.pageFormat] || 16/9;
  
  // Card size presets
  const sizePresets = {
    small: { width: 540, basePadding: 32, baseFontTitle: 32, baseFontBody: 16 },
    medium: { width: 720, basePadding: 42, baseFontTitle: 42, baseFontBody: 20 },
    large: { width: 900, basePadding: 52, baseFontTitle: 52, baseFontBody: 24 },
    xlarge: { width: 1080, basePadding: 60, baseFontTitle: 60, baseFontBody: 28 }
  };
  
  const { preset, width: customWidth, height: customHeight, aspectRatio, contentScale } = bgSettings.cardSize;
  let cardWidth, basePadding, baseFontTitle, baseFontBody;
  
  if (preset === 'custom') {
    cardWidth = customWidth || 720;
    const scaleFactor = cardWidth / 720;
    basePadding = Math.round(42 * scaleFactor);
    baseFontTitle = Math.round(42 * scaleFactor);
    baseFontBody = Math.round(20 * scaleFactor);
  } else {
    const presetData = sizePresets[preset] || sizePresets.medium;
    cardWidth = presetData.width;
    basePadding = presetData.basePadding;
    baseFontTitle = presetData.baseFontTitle;
    baseFontBody = presetData.baseFontBody;
  }
  
  // Apply content scale
  const scale = contentScale / 100;
  const finalFontTitle = Math.round(baseFontTitle * scale);
  const finalFontBody = Math.round(baseFontBody * scale);
  const finalPadding = Math.round(basePadding * scale);
  
  // Calculate card height based on aspect ratio
  let cardHeight;
  if (preset === 'custom' && customHeight) {
    cardHeight = customHeight;
  } else if (aspectRatio && aspectRatio !== 'auto') {
    const [w, h] = aspectRatio.split(':').map(Number);
    cardHeight = Math.round(cardWidth / (w / h));
  } else {
    cardHeight = null; // auto height
  }
  
  // Apply to slide
  slide.style.width = cardWidth + 'px';
  slide.style.minHeight = cardHeight ? 'unset' : '400px';
  slide.style.height = cardHeight ? cardHeight + 'px' : 'auto';
  slide.style.padding = `${finalPadding}px ${Math.round(finalPadding * 1.2)}px`;
  
  // Apply font sizes via CSS variables
  slide.style.setProperty('--title-size', finalFontTitle + 'px');
  slide.style.setProperty('--body-size', finalFontBody + 'px');
  slide.style.setProperty('--chip-size', Math.round(finalFontBody * 0.7) + 'px');
  slide.style.setProperty('--meta-size', Math.round(finalFontBody * 0.7) + 'px');
  
  // Update wrapper size based on page format
  const padding = 40;
  let w = cardWidth + padding * 2;
  let h = w / ratio;
  wrapper.style.width = w + 'px';
  wrapper.style.height = h + 'px';
  wrapper.style.maxWidth = '100%';
}

// Render template selector
function renderTemplateSelector() {
  const container = $('templateSelector');
  container.innerHTML = '';
  Object.entries(TEMPLATES).forEach(([key, tpl]) => {
    const btn = document.createElement('div');
    btn.className = 'templateBtn' + (slides[active]?.template === key ? ' active' : '');
    btn.innerHTML = `<span class="icon">${tpl.icon}</span>${tpl.name}`;
    btn.onclick = () => {
      slides[active].template = key;
      Object.assign(slides[active], JSON.parse(JSON.stringify(tpl.defaults)));
      renderActive();
    };
    container.appendChild(btn);
  });
}

// Render template fields
function renderTemplateFields() {
  const container = $('templateFields');
  container.innerHTML = '';
  const slide = slides[active];
  const tpl = TEMPLATES[slide.template];
  
  tpl.fields.forEach(fieldKey => {
    const def = FIELD_DEFS[fieldKey];
    if (!def) return;
    
    const field = document.createElement('div');
    field.className = 'field';
    
    if (def.type === 'input') {
      field.innerHTML = `<label>${def.label}</label><input id="f_${fieldKey}" placeholder="${def.placeholder || ''}" />`;
      container.appendChild(field);
      const input = field.querySelector('input');
      input.value = slide[fieldKey] || '';
      input.oninput = () => { slide[fieldKey] = input.value; renderSlide(); };
    }
    else if (def.type === 'textarea') {
      field.innerHTML = `<label>${def.label}</label><textarea id="f_${fieldKey}"></textarea>`;
      container.appendChild(field);
      const ta = field.querySelector('textarea');
      ta.value = slide[fieldKey] || '';
      ta.oninput = () => { slide[fieldKey] = ta.value; renderSlide(); };
    }
    else if (def.type === 'select') {
      let opts = def.options.map(([v, l]) => `<option value="${v}">${l}</option>`).join('');
      field.innerHTML = `<label>${def.label}</label><select id="f_${fieldKey}">${opts}</select>`;
      container.appendChild(field);
      const sel = field.querySelector('select');
      sel.value = slide[fieldKey] || def.options[0][0];
      sel.onchange = () => { slide[fieldKey] = sel.value; renderSlide(); };
    }
    else if (def.type === 'color') {
      field.innerHTML = `<label>${def.label}</label><input type="color" id="f_${fieldKey}" />`;
      container.appendChild(field);
      const input = field.querySelector('input');
      input.value = slide[fieldKey] || '#00bf63';
      input.oninput = () => { slide[fieldKey] = input.value; renderSlide(); };
    }
    else if (def.type === 'array') {
      field.innerHTML = `<label>${def.label}</label><div id="arr_${fieldKey}"></div><button class="btnGhost btnSmall" onclick="addArrayItem('${fieldKey}')">+ Ø¥Ø¶Ø§ÙØ©</button>`;
      container.appendChild(field);
      renderArrayField(fieldKey, slide[fieldKey] || []);
    }
    else if (def.type === 'tocArray') {
      field.innerHTML = `<label>${def.label}</label><div id="arr_${fieldKey}"></div><button class="btnGhost btnSmall" onclick="addTocItem()">+ Ø¥Ø¶Ø§ÙØ©</button>`;
      container.appendChild(field);
      renderTocField(slide[fieldKey] || []);
    }
    else if (def.type === 'statsArray') {
      field.innerHTML = `<label>${def.label}</label><div id="arr_${fieldKey}"></div><button class="btnGhost btnSmall" onclick="addStatItem()">+ Ø¥Ø¶Ø§ÙØ©</button>`;
      container.appendChild(field);
      renderStatsField(slide[fieldKey] || []);
    }
    else if (def.type === 'timelineArray') {
      field.innerHTML = `<label>${def.label}</label><div id="arr_${fieldKey}"></div><button class="btnGhost btnSmall" onclick="addTimelineItem()">+ Ø¥Ø¶Ø§ÙØ©</button>`;
      container.appendChild(field);
      renderTimelineField(slide[fieldKey] || []);
    }
    else if (def.type === 'chartDatasetsArray') {
      field.innerHTML = `<label>${def.label}</label><div id="arr_chartDatasets"></div><button class="btnGhost btnSmall" onclick="addChartDataset()">+ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ</button>`;
      container.appendChild(field);
      renderChartDatasetsField(slide[fieldKey] || []);
    }
  });
}

function renderArrayField(key, arr) {
  const container = $(`arr_${key}`);
  if (!container) return;
  container.innerHTML = '';
  arr.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'dataRow';
    row.innerHTML = `<input value="${item}" onchange="updateArrayItem('${key}', ${i}, this.value)" /><button class="btnDanger btnSmall" onclick="removeArrayItem('${key}', ${i})">Ã—</button>`;
    container.appendChild(row);
  });
}

window.addArrayItem = function(key) {
  if (!slides[active][key]) slides[active][key] = [];
  slides[active][key].push('Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯');
  renderTemplateFields();
  renderSlide();
};
window.updateArrayItem = function(key, i, val) {
  slides[active][key][i] = val;
  renderSlide();
};
window.removeArrayItem = function(key, i) {
  slides[active][key].splice(i, 1);
  renderTemplateFields();
  renderSlide();
};

function renderTocField(items) {
  const container = $('arr_tocItems');
  if (!container) return;
  container.innerHTML = '';
  items.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'dataRow';
    row.innerHTML = `<input value="${item.text}" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" onchange="updateTocItem(${i}, 'text', this.value)" style="flex:2" /><input value="${item.page}" placeholder="Ø§Ù„ØµÙØ­Ø©" onchange="updateTocItem(${i}, 'page', this.value)" style="width:60px;flex:none" /><button class="btnDanger btnSmall" onclick="removeTocItem(${i})">Ã—</button>`;
    container.appendChild(row);
  });
}
window.addTocItem = function() {
  if (!slides[active].tocItems) slides[active].tocItems = [];
  slides[active].tocItems.push({ text: 'Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯', page: '00' });
  renderTemplateFields();
  renderSlide();
};
window.updateTocItem = function(i, key, val) {
  slides[active].tocItems[i][key] = val;
  renderSlide();
};
window.removeTocItem = function(i) {
  slides[active].tocItems.splice(i, 1);
  renderTemplateFields();
  renderSlide();
};

function renderStatsField(items) {
  const container = $('arr_stats');
  if (!container) return;
  container.innerHTML = '';
  items.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'dataRow';
    row.innerHTML = `<input value="${item.number}" placeholder="Ø§Ù„Ø±Ù‚Ù…" onchange="updateStatItem(${i}, 'number', this.value)" /><input value="${item.label}" placeholder="Ø§Ù„ÙˆØµÙ" onchange="updateStatItem(${i}, 'label', this.value)" /><button class="btnDanger btnSmall" onclick="removeStatItem(${i})">Ã—</button>`;
    container.appendChild(row);
  });
}
window.addStatItem = function() {
  if (!slides[active].stats) slides[active].stats = [];
  slides[active].stats.push({ number: '0', label: 'ÙˆØµÙ' });
  renderTemplateFields();
  renderSlide();
};
window.updateStatItem = function(i, key, val) {
  slides[active].stats[i][key] = val;
  renderSlide();
};
window.removeStatItem = function(i) {
  slides[active].stats.splice(i, 1);
  renderTemplateFields();
  renderSlide();
};

function renderTimelineField(items) {
  const container = $('arr_timelineItems');
  if (!container) return;
  container.innerHTML = '';
  items.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'dataRow';
    row.innerHTML = `<input value="${item.date}" placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ®" onchange="updateTimelineItem(${i}, 'date', this.value)" style="width:80px;flex:none" /><input value="${item.text}" placeholder="Ø§Ù„ÙˆØµÙ" onchange="updateTimelineItem(${i}, 'text', this.value)" /><button class="btnDanger btnSmall" onclick="removeTimelineItem(${i})">Ã—</button>`;
    container.appendChild(row);
  });
}
window.addTimelineItem = function() {
  if (!slides[active].timelineItems) slides[active].timelineItems = [];
  slides[active].timelineItems.push({ date: '2025', text: 'Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯' });
  renderTemplateFields();
  renderSlide();
};
window.updateTimelineItem = function(i, key, val) {
  slides[active].timelineItems[i][key] = val;
  renderSlide();
};
window.removeTimelineItem = function(i) {
  slides[active].timelineItems.splice(i, 1);
  renderTemplateFields();
  renderSlide();
};

// Chart Datasets (Multi-Chart)
const CHART_TYPES_OVERLAY = [['bar', 'Ø£Ø¹Ù…Ø¯Ø©'], ['line', 'Ø®Ø·ÙŠ'], ['area', 'Ù…Ø³Ø§Ø­Ø©']];
const CHART_TYPES_ALL = [['bar', 'Ø£Ø¹Ù…Ø¯Ø©'], ['line', 'Ø®Ø·ÙŠ'], ['area', 'Ù…Ø³Ø§Ø­Ø©'], ['pie', 'Ø¯Ø§Ø¦Ø±ÙŠ'], ['doughnut', 'Ø­Ù„Ù‚ÙŠ'], ['radar', 'Ø±Ø§Ø¯Ø§Ø±']];
const CHART_COLORS = ['#00bf63', '#008cff', '#ff8c00', '#b400ff', '#ff4d4d', '#00d4aa', '#ff6b9d', '#ffd93d'];

function renderChartDatasetsField(datasets) {
  const container = $('arr_chartDatasets');
  if (!container) return;
  container.innerHTML = '';
  const mode = slides[active].multiChartMode || 'overlay';
  const chartTypes = mode === 'sideBySide' ? CHART_TYPES_ALL : CHART_TYPES_OVERLAY;
  
  datasets.forEach((ds, i) => {
    const item = document.createElement('div');
    item.style.cssText = 'background:rgba(255,255,255,.03);padding:12px;border-radius:10px;margin-bottom:10px;border-right:3px solid ' + ds.color;
    const typeOptions = chartTypes.map(([v, l]) => `<option value="${v}" ${ds.type === v ? 'selected' : ''}>${l}</option>`).join('');
    item.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <span style="font-size:13px;font-weight:800;color:${ds.color}">Ø±Ø³Ù… ${i + 1}</span>
        <button class="btnDanger btnSmall" onclick="removeChartDataset(${i})">Ø­Ø°Ù</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <select onchange="updateChartDataset(${i},'type',this.value)" style="flex:1">${typeOptions}</select>
        <input type="color" value="${ds.color}" onchange="updateChartDataset(${i},'color',this.value)" style="width:50px;flex:none" />
      </div>
      <div class="field" style="margin-bottom:8px">
        <input value="${ds.label || ''}" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ù…" onchange="updateChartDataset(${i},'label',this.value)" />
      </div>
      <div class="field">
        <input value="${Array.isArray(ds.data) ? ds.data.join(', ') : ds.data}" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)" onchange="updateChartDataset(${i},'data',this.value)" />
      </div>
    `;
    container.appendChild(item);
  });
}

window.addChartDataset = function() {
  if (!slides[active].chartDatasets) slides[active].chartDatasets = [];
  const idx = slides[active].chartDatasets.length;
  const color = CHART_COLORS[idx % CHART_COLORS.length];
  slides[active].chartDatasets.push({ type: 'bar', label: `Ø¨ÙŠØ§Ù†Ø§Øª ${idx + 1}`, data: [20, 30, 40, 50], color });
  renderTemplateFields();
  renderSlide();
};
window.updateChartDataset = function(i, key, val) {
  if (key === 'data') {
    slides[active].chartDatasets[i][key] = val.split(',').map(s => parseFloat(s.trim()) || 0);
  } else {
    slides[active].chartDatasets[i][key] = val;
  }
  if (key === 'type') renderTemplateFields();
  renderSlide();
};
window.removeChartDataset = function(i) {
  slides[active].chartDatasets.splice(i, 1);
  renderTemplateFields();
  renderSlide();
};

// Render the actual slide content
function renderSlide() {
  const slide = slides[active];
  const root = $('slideExportRoot');
  let html = '';

  switch (slide.template) {
    case 'text':
      html = `
        <div class="slideHeader">
          <div>
            <h2 class="slideTitle">${slide.title || ''}</h2>
            <div class="chip"><span class="chipDot"></span><span>${slide.chip || ''}</span></div>
          </div>
          <div class="slideMeta"><div>${slide.author || ''}</div><div>${pad2(active + 1)} / ${pad2(slides.length)}</div></div>
        </div>
        <div class="slideBody">${slide.body || ''}</div>
        <div class="slideFooter"><span>${slide.footerLeft || ''}</span><span>${slide.footerRight || ''}</span></div>
      `;
      break;

    case 'image':
      html = `
        <div class="slideHeader">
          <h2 class="slideTitle">${slide.title || ''}</h2>
          <div class="slideMeta"><div>${slide.author || ''}</div><div>${pad2(active + 1)} / ${pad2(slides.length)}</div></div>
        </div>
        ${slide.imageUrl ? `<img class="slideImage" src="${slide.imageUrl}" alt="" />` : '<div class="slideImage" style="background:rgba(255,255,255,.05);display:flex;align-items:center;justify-content:center;height:300px">Ø£Ø¶Ù Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©</div>'}
        ${slide.caption ? `<div class="slideBody" style="margin-top:10px;font-size:16px;text-align:center">${slide.caption}</div>` : ''}
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'textImage':
      const pos = slide.imagePosition || 'bottom';
      const imgHtml = slide.imageUrl ? `<img src="${slide.imageUrl}" alt="" />` : '<div style="background:rgba(255,255,255,.05);height:200px;border-radius:16px;display:flex;align-items:center;justify-content:center">ØµÙˆØ±Ø©</div>';
      const textHtml = `<div><h3 style="margin:0 0 12px;font-size:24px">${slide.title || ''}</h3><div style="color:var(--muted);line-height:1.7">${slide.body || ''}</div></div>`;
      
      if (pos === 'top' || pos === 'bottom') {
        html = `
          <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
          ${pos === 'top' ? imgHtml : ''}
          <div class="slideBody">${slide.body || ''}</div>
          ${pos === 'bottom' ? imgHtml : ''}
          <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
        `;
      } else {
        html = `
          <div class="splitLayout ${pos === 'left' ? 'reverse' : ''}" style="margin-top:0">
            ${textHtml}
            ${imgHtml}
          </div>
          <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
        `;
      }
      break;

    case 'table':
      const headers = slide.tableHeaders || [];
      const rows = slide.tableRows || [];
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
        <table class="slideTable">
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody>${rows.map(row => `<tr>${(Array.isArray(row) ? row : [row]).map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>
        </table>
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'chart':
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
        <div class="slideChart"><canvas id="chartCanvas"></canvas></div>
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'multiChart':
      const datasets = slide.chartDatasets || [];
      if (slide.multiChartMode === 'sideBySide') {
        const cols = Math.min(datasets.length, 3);
        const canvases = datasets.map((_, i) => `<div class="slideChart" style="height:${datasets.length > 2 ? '180px' : '220px'}"><canvas id="chartCanvasMulti${i}"></canvas></div>`).join('');
        html = `
          <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
          <div style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:15px;margin:20px 0;position:relative;z-index:1">
            ${canvases}
          </div>
          <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
        `;
      } else {
        html = `
          <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
          <div class="slideChart"><canvas id="chartCanvasMulti"></canvas></div>
          <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
        `;
      }
      break;

    case 'intro':
      html = `
        <div class="introContent">
          <h1 class="slideTitle">${slide.title || ''}</h1>
          <p class="subtitle">${slide.subtitle || ''}</p>
          <div class="authorInfo">
            ${slide.authorAvatar ? `<img class="authorAvatar" src="${slide.authorAvatar}" alt="" />` : ''}
            <div style="text-align:right">
              <div style="font-weight:800;font-size:18px">${slide.authorName || ''}</div>
              <div style="color:var(--muted)">${slide.authorTitle || ''}</div>
            </div>
          </div>
          <div style="margin-top:30px;color:var(--muted)">${slide.date || ''}</div>
        </div>
      `;
      break;

    case 'outro':
      html = `
        <div class="outroContent">
          <div class="thankYou">${slide.thankYouText || 'Ø´ÙƒØ±Ø§Ù‹'}</div>
          <div class="contactInfo">
            ${slide.email ? `<div class="contactItem">ğŸ“§ <a href="mailto:${slide.email}" style="color:var(--accent)">${slide.email}</a></div>` : ''}
            ${slide.website ? `<div class="contactItem">ğŸŒ <a href="https://${slide.website}" target="_blank" style="color:var(--accent)">${slide.website}</a></div>` : ''}
            ${slide.social ? `<div class="contactItem">ğŸ“± ${slide.social}</div>` : ''}
          </div>
        </div>
      `;
      break;

    case 'toc':
      const tocItems = slide.tocItems || [];
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || 'Ø§Ù„ÙÙ‡Ø±Ø³'}</h2></div>
        <div class="tocContent">
          ${tocItems.map(item => `<div class="tocItem"><span>${item.text}</span><span class="tocDots"></span><span>${item.page}</span></div>`).join('')}
        </div>
      `;
      break;

    case 'video':
      let videoHtml = '';
      if (slide.videoUrl) {
        if (slide.videoType === 'youtube') {
          const vid = slide.videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/)?.[1];
          videoHtml = vid ? `<iframe class="slideVideo" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>` : '';
        } else if (slide.videoType === 'vimeo') {
          const vid = slide.videoUrl.match(/vimeo\.com\/(\d+)/)?.[1];
          videoHtml = vid ? `<iframe class="slideVideo" src="https://player.vimeo.com/video/${vid}" frameborder="0" allowfullscreen></iframe>` : '';
        } else {
          videoHtml = `<video class="slideVideo" src="${slide.videoUrl}" controls></video>`;
        }
      } else {
        videoHtml = '<div class="slideVideo" style="display:flex;align-items:center;justify-content:center;color:var(--muted)">Ø£Ø¶Ù Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ</div>';
      }
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
        ${videoHtml}
        ${slide.caption ? `<div style="text-align:center;color:var(--muted);margin-top:10px">${slide.caption}</div>` : ''}
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'quote':
      html = `
        <div class="quoteContent">
          <div class="quoteText">${slide.quoteText || ''}</div>
          <div class="quoteAuthor">â€” ${slide.quoteAuthor || ''}</div>
        </div>
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'bullets':
      const bullets = slide.bulletItems || [];
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
        <ul class="bulletList">${bullets.map(b => `<li>${b}</li>`).join('')}</ul>
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'stats':
      const stats = slide.stats || [];
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
        <div class="statGrid">${stats.map(s => `<div class="statItem"><div class="statNumber">${s.number}</div><div class="statLabel">${s.label}</div></div>`).join('')}</div>
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'timeline':
      const tlItems = slide.timelineItems || [];
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
        <div style="margin-top:20px">${tlItems.map(t => `<div class="timelineItem"><span class="timelineDate">${t.date}</span><span>${t.text}</span></div>`).join('')}</div>
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'comparison':
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
        <div class="comparisonGrid">
          <div class="comparisonItem pros">
            <div class="comparisonTitle">âœ“ ${slide.prosTitle || 'Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª'}</div>
            <ul style="margin:0;padding-right:20px">${(slide.prosItems || []).map(p => `<li>${p}</li>`).join('')}</ul>
          </div>
          <div class="comparisonItem cons">
            <div class="comparisonTitle">âœ— ${slide.consTitle || 'Ø§Ù„Ø¹ÙŠÙˆØ¨'}</div>
            <ul style="margin:0;padding-right:20px">${(slide.consItems || []).map(c => `<li>${c}</li>`).join('')}</ul>
          </div>
        </div>
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;

    case 'code':
      html = `
        <div class="slideHeader"><h2 class="slideTitle">${slide.title || ''}</h2></div>
        <div style="background:#1a1a2e;border-radius:12px;padding:20px;margin:20px 0;position:relative;z-index:1">
          <div style="color:var(--accent);font-size:12px;margin-bottom:10px">${slide.codeLanguage || ''}</div>
          <pre style="margin:0;color:#e0e0e0;font-family:monospace;white-space:pre-wrap;direction:ltr;text-align:left">${slide.codeContent || ''}</pre>
        </div>
        <div class="slideFooter"><span>${slide.author || ''}</span><span>${pad2(active + 1)} / ${pad2(slides.length)}</span></div>
      `;
      break;
  }

  root.innerHTML = html;

  // Render chart if needed
  if (slide.template === 'chart') {
    setTimeout(() => renderChart(slide), 50);
  }
  if (slide.template === 'multiChart') {
    setTimeout(() => renderMultiChart(slide), 50);
  }
}

function renderChart(slide) {
  const canvas = $('chartCanvas');
  if (!canvas) return;
  
  const labels = typeof slide.chartLabels === 'string' ? slide.chartLabels.split(',').map(s => s.trim()) : slide.chartLabels || [];
  const data = typeof slide.chartData === 'string' ? slide.chartData.split(',').map(s => parseFloat(s.trim())) : slide.chartData || [];
  
  new Chart(canvas, {
    type: slide.chartType || 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: ['rgba(0,191,99,.7)', 'rgba(0,140,255,.7)', 'rgba(255,140,0,.7)', 'rgba(180,0,255,.7)', 'rgba(255,77,77,.7)'],
        borderColor: ['#00bf63', '#008cff', '#ff8c00', '#b400ff', '#ff4d4d'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: slide.chartType === 'pie' || slide.chartType === 'doughnut' ? {} : {
        y: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,.1)' } },
        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,.1)' } }
      }
    }
  });
}

function renderMultiChart(slide) {
  const labels = typeof slide.chartLabels === 'string' ? slide.chartLabels.split(',').map(s => s.trim()) : slide.chartLabels || [];
  const datasets = slide.chartDatasets || [];

  const makeDataset = (ds, idx) => {
    const data = typeof ds.data === 'string' ? ds.data.split(',').map(s => parseFloat(s.trim())) : ds.data || [];
    const color = ds.color || CHART_COLORS[idx % CHART_COLORS.length];
    const base = {
      label: ds.label || `Ø¨ÙŠØ§Ù†Ø§Øª ${idx + 1}`,
      data: data,
      borderColor: color,
      borderWidth: 2
    };
    
    if (ds.type === 'area') {
      base.fill = true;
      base.backgroundColor = hexToRgba(color, 0.2);
      base.tension = 0.3;
    } else if (ds.type === 'bar') {
      base.backgroundColor = hexToRgba(color, 0.7);
    } else if (ds.type === 'pie' || ds.type === 'doughnut') {
      base.backgroundColor = data.map((_, i) => hexToRgba(CHART_COLORS[i % CHART_COLORS.length], 0.7));
      base.borderColor = data.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);
    } else if (ds.type === 'radar') {
      base.backgroundColor = hexToRgba(color, 0.2);
      base.pointBackgroundColor = color;
    } else {
      base.fill = false;
      base.backgroundColor = 'transparent';
      base.tension = 0.3;
    }
    
    if (idx > 0 && slide.multiChartMode === 'overlay') {
      base.yAxisID = `y${idx}`;
    }
    return base;
  };

  if (slide.multiChartMode === 'sideBySide') {
    datasets.forEach((ds, i) => {
      const canvas = $(`chartCanvasMulti${i}`);
      if (!canvas) return;
      const data = typeof ds.data === 'string' ? ds.data.split(',').map(s => parseFloat(s.trim())) : ds.data || [];
      const color = ds.color || CHART_COLORS[i % CHART_COLORS.length];
      const isPolar = ds.type === 'pie' || ds.type === 'doughnut';
      
      new Chart(canvas, {
        type: ds.type === 'area' ? 'line' : ds.type,
        data: { 
          labels, 
          datasets: [{
            label: ds.label,
            data: data,
            backgroundColor: isPolar ? data.map((_, j) => hexToRgba(CHART_COLORS[j % CHART_COLORS.length], 0.7)) : (ds.type === 'bar' ? hexToRgba(color, 0.7) : (ds.type === 'area' || ds.type === 'radar' ? hexToRgba(color, 0.2) : 'transparent')),
            borderColor: isPolar ? data.map((_, j) => CHART_COLORS[j % CHART_COLORS.length]) : color,
            borderWidth: 2,
            fill: ds.type === 'area',
            tension: ds.type === 'line' || ds.type === 'area' ? 0.3 : 0,
            pointBackgroundColor: ds.type === 'radar' ? color : undefined
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: true, labels: { color: '#aaa', font: { size: 10 } } } },
          scales: isPolar ? {} : { 
            y: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,.1)' } }, 
            x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,.1)' } },
            ...(ds.type === 'radar' ? { r: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,.1)' } } } : {})
          }
        }
      });
    });
  } else {
    const canvas = $('chartCanvasMulti');
    if (!canvas) return;
    
    const scales = { x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,.1)' } } };
    datasets.forEach((ds, i) => {
      const color = ds.color || CHART_COLORS[i % CHART_COLORS.length];
      if (i === 0) {
        scales.y = { type: 'linear', position: 'right', ticks: { color }, grid: { color: 'rgba(255,255,255,.1)' } };
      } else {
        scales[`y${i}`] = { type: 'linear', position: 'left', ticks: { color }, grid: { drawOnChartArea: false } };
      }
    });
    
    new Chart(canvas, {
      data: {
        labels,
        datasets: datasets.map((ds, i) => ({
          ...makeDataset(ds, i),
          type: ds.type === 'area' ? 'line' : ds.type
        }))
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: true, labels: { color: '#aaa' } } },
        scales
      }
    });
  }
}

function renderThumbs() {
  const strip = $('thumbStrip');
  strip.innerHTML = '';
  slides.forEach((s, i) => {
    const t = document.createElement('div');
    t.className = 'thumb' + (i === active ? ' active' : '');
    t.onclick = () => { active = i; renderActive(); };
    t.innerHTML = `
      <span class="thumbIndex">${pad2(i + 1)}</span>
      <span class="thumbType">${TEMPLATES[s.template]?.icon || ''}</span>
      <div class="thumbTitle">${s.title || s.thankYouText || s.quoteText?.slice(0, 20) || ''}</div>
    `;
    strip.appendChild(t);
  });
}

function renderActive() {
  renderTemplateSelector();
  renderTemplateFields();
  renderSlide();
  renderThumbs();
  applyBackgrounds();
}

// Glows
function renderGlowsList() {
  const container = $('glowsList');
  container.innerHTML = '';
  bgSettings.glows.forEach((g, i) => {
    const item = document.createElement('div');
    item.style.cssText = 'background:rgba(255,255,255,.03);padding:10px;border-radius:10px;margin-bottom:8px';
    item.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:12px;color:var(--muted)">ØªÙˆÙ‡Ø¬ ${i + 1}</span>
        <button class="btnDanger btnSmall" onclick="removeGlow(${i})">Ø­Ø°Ù</button>
      </div>
      <div class="row" style="margin-bottom:6px">
        <input type="color" value="${g.color}" onchange="updateGlow(${i},'color',this.value)" />
        <input type="number" value="${g.opacity}" min="1" max="100" placeholder="Ø§Ù„Ù‚ÙˆØ©" onchange="updateGlow(${i},'opacity',+this.value)" />
      </div>
      <div class="row">
        <input type="range" value="${g.x}" min="0" max="100" onchange="updateGlow(${i},'x',+this.value)" title="X" />
        <input type="range" value="${g.y}" min="0" max="100" onchange="updateGlow(${i},'y',+this.value)" title="Y" />
      </div>
    `;
    container.appendChild(item);
  });
}
window.updateGlow = (i, k, v) => { bgSettings.glows[i][k] = v; applyBackgrounds(); };
window.removeGlow = i => { bgSettings.glows.splice(i, 1); renderGlowsList(); applyBackgrounds(); };
$('btnAddGlow').onclick = () => {
  bgSettings.glows.push({ color: '#ffffff', x: 50, y: 50, width: 500, height: 400, opacity: 15, spread: 50 });
  renderGlowsList();
  applyBackgrounds();
};

// Background controls
$('cardBgType').onchange = function() {
  bgSettings.card.type = this.value;
  $('cardGradientOptions').style.display = this.value === 'gradient' ? 'block' : 'none';
  $('cardSolidOptions').style.display = this.value === 'solid' ? 'block' : 'none';
  $('cardImageOptions').style.display = this.value === 'image' ? 'block' : 'none';
  applyBackgrounds();
};
$('cardGradient1').oninput = function() { bgSettings.card.gradient1 = this.value; applyBackgrounds(); };
$('cardGradient2').oninput = function() { bgSettings.card.gradient2 = this.value; applyBackgrounds(); };
$('cardSolidColor').oninput = function() { bgSettings.card.solidColor = this.value; applyBackgrounds(); };
$('cardImageUrl').oninput = function() { bgSettings.card.imageUrl = this.value; applyBackgrounds(); };

$('pdfBgType').onchange = function() {
  bgSettings.pdf.type = this.value;
  $('pdfGradientOptions').style.display = this.value === 'gradient' ? 'block' : 'none';
  $('pdfSolidOptions').style.display = this.value === 'solid' ? 'block' : 'none';
  applyBackgrounds();
};
$('pdfGradient1').oninput = function() { bgSettings.pdf.gradient1 = this.value; applyBackgrounds(); };
$('pdfGradient2').oninput = function() { bgSettings.pdf.gradient2 = this.value; applyBackgrounds(); };
$('pdfSolidColor').oninput = function() { bgSettings.pdf.solidColor = this.value; applyBackgrounds(); };
$('syncBgWithCard').onchange = function() {
  bgSettings.pdf.syncWithCard = this.checked;
  $('pdfCustomBgOptions').style.display = this.checked ? 'none' : 'block';
  applyBackgrounds();
};
$('pageFormat').onchange = function() {
  bgSettings.pageFormat = this.value;
  updateSlideWrapSize();
};

// Card Size Controls
$('cardSizePreset').onchange = function() {
  bgSettings.cardSize.preset = this.value;
  $('cardCustomSizeOptions').style.display = this.value === 'custom' ? 'block' : 'none';
  updateSlideWrapSize();
};
$('cardCustomWidth').oninput = function() {
  bgSettings.cardSize.width = parseInt(this.value) || 720;
  updateSlideWrapSize();
};
$('cardCustomHeight').oninput = function() {
  bgSettings.cardSize.height = parseInt(this.value) || null;
  updateSlideWrapSize();
};
$('cardAspectRatio').onchange = function() {
  bgSettings.cardSize.aspectRatio = this.value;
  updateSlideWrapSize();
};
$('cardContentScale').oninput = function() {
  bgSettings.cardSize.contentScale = parseInt(this.value);
  $('cardContentScaleValue').textContent = this.value + '%';
  updateSlideWrapSize();
};

// Collapsible
document.querySelectorAll('.collapsible').forEach(el => {
  el.onclick = function() {
    const target = $(this.dataset.target);
    this.classList.toggle('collapsed');
    target.classList.toggle('collapsed');
  };
});

// Navigation
$('btnNew').onclick = () => {
  slides.push(createSlide('text'));
  active = slides.length - 1;
  renderActive();
};
$('btnDup').onclick = () => {
  slides.splice(active + 1, 0, JSON.parse(JSON.stringify(slides[active])));
  active++;
  renderActive();
};
$('btnDel').onclick = () => {
  if (slides.length === 1) {
    slides = [createSlide('text')];
    active = 0;
  } else {
    slides.splice(active, 1);
    active = Math.max(0, active - 1);
  }
  renderActive();
};
$('btnPrev').onclick = () => { active = Math.max(0, active - 1); renderActive(); };
$('btnNext').onclick = () => { active = Math.min(slides.length - 1, active + 1); renderActive(); };

// Export
$('btnExport').onclick = async () => {
  const { jsPDF } = window.jspdf;
  const formats = {
    '16:9': { w: 1920, h: 1080 }, '1:1': { w: 1080, h: 1080 }, '4:5': { w: 1080, h: 1350 },
    '9:16': { w: 1080, h: 1920 }, '4:3': { w: 1440, h: 1080 }, 'A4': { w: 595, h: 842 }, 'A4-L': { w: 842, h: 595 }
  };
  const { w, h } = formats[bgSettings.pageFormat] || formats['16:9'];
  const pdf = new jsPDF({ orientation: w > h ? 'landscape' : 'portrait', unit: 'pt', format: [w, h] });
  
  const originalActive = active;
  for (let i = 0; i < slides.length; i++) {
    active = i;
    renderSlide();
    await new Promise(r => setTimeout(r, 100));
    
    const canvas = await html2canvas($('exportWrapper'), { backgroundColor: null, scale: 2, useCORS: true });
    if (i > 0) pdf.addPage();
    
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    pdf.setFillColor(bgSettings.pdf.gradient1 || '#070a12');
    pdf.rect(0, 0, pageW, pageH, 'F');
    
    const ratio = Math.min((pageW - 40) / canvas.width, (pageH - 40) / canvas.height);
    const dw = canvas.width * ratio, dh = canvas.height * ratio;
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', (pageW - dw) / 2, (pageH - dh) / 2, dw, dh);
  }
  
  active = originalActive;
  renderActive();
  pdf.save('Liquid-Glass-Slides.pdf');
};

// Save/Load Project
$('btnSaveProject').onclick = () => {
  const project = {
    version: '1.0',
    createdAt: new Date().toISOString(),
    slides: slides,
    bgSettings: bgSettings,
    active: active
  };
  const json = JSON.stringify(project, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Liquid-Glass-Project-${new Date().toISOString().slice(0,10)}.lgs`;
  a.click();
  URL.revokeObjectURL(url);
};

$('btnLoadProject').onclick = () => {
  $('fileInput').click();
};

$('fileInput').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const project = JSON.parse(event.target.result);
      
      // Validate project structure
      if (!project.slides || !Array.isArray(project.slides)) {
        alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­!');
        return;
      }
      
      // Load slides
      slides = project.slides;
      
      // Load settings if available
      if (project.bgSettings) {
        Object.assign(bgSettings, project.bgSettings);
        
        // Update UI controls
        $('cardBgType').value = bgSettings.card.type;
        $('cardGradient1').value = bgSettings.card.gradient1;
        $('cardGradient2').value = bgSettings.card.gradient2;
        $('cardSolidColor').value = bgSettings.card.solidColor;
        $('cardImageUrl').value = bgSettings.card.imageUrl || '';
        
        $('pdfBgType').value = bgSettings.pdf.type;
        $('pdfGradient1').value = bgSettings.pdf.gradient1;
        $('pdfGradient2').value = bgSettings.pdf.gradient2;
        $('pdfSolidColor').value = bgSettings.pdf.solidColor;
        $('syncBgWithCard').checked = bgSettings.pdf.syncWithCard;
        
        $('pageFormat').value = bgSettings.pageFormat;
        
        if (bgSettings.cardSize) {
          $('cardSizePreset').value = bgSettings.cardSize.preset;
          $('cardCustomWidth').value = bgSettings.cardSize.width;
          $('cardCustomHeight').value = bgSettings.cardSize.height || 450;
          $('cardAspectRatio').value = bgSettings.cardSize.aspectRatio;
          $('cardContentScale').value = bgSettings.cardSize.contentScale;
          $('cardContentScaleValue').textContent = bgSettings.cardSize.contentScale + '%';
          $('cardCustomSizeOptions').style.display = bgSettings.cardSize.preset === 'custom' ? 'block' : 'none';
        }
        
        // Update visibility
        $('cardGradientOptions').style.display = bgSettings.card.type === 'gradient' ? 'block' : 'none';
        $('cardSolidOptions').style.display = bgSettings.card.type === 'solid' ? 'block' : 'none';
        $('cardImageOptions').style.display = bgSettings.card.type === 'image' ? 'block' : 'none';
        $('pdfGradientOptions').style.display = bgSettings.pdf.type === 'gradient' ? 'block' : 'none';
        $('pdfSolidOptions').style.display = bgSettings.pdf.type === 'solid' ? 'block' : 'none';
        $('pdfCustomBgOptions').style.display = bgSettings.pdf.syncWithCard ? 'none' : 'block';
      }
      
      // Set active slide
      active = project.active || 0;
      if (active >= slides.length) active = 0;
      
      // Refresh UI
      renderActive();
      renderGlowsList();
      updateSlideWrapSize();
      applyBackgrounds();
      
      alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­! \nØ¹Ø¯Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­: ' + slides.length);
    } catch (err) {
      console.error(err);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù!');
    }
  };
  reader.readAsText(file);
  e.target.value = ''; // Reset input
};

// Auto-save to localStorage
function autoSave() {
  const project = { slides, bgSettings, active };
  localStorage.setItem('liquidGlassAutoSave', JSON.stringify(project));
}

function loadAutoSave() {
  const saved = localStorage.getItem('liquidGlassAutoSave');
  if (saved) {
    try {
      const project = JSON.parse(saved);
      if (project.slides && project.slides.length > 0) {
        return project;
      }
    } catch(e) {}
  }
  return null;
}

// Auto-save every 30 seconds
setInterval(autoSave, 30000);

// Init
const autoSaved = loadAutoSave();
if (autoSaved && autoSaved.slides.length > 0) {
  if (confirm('ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø­ÙÙˆØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ØŸ')) {
    slides = autoSaved.slides;
    if (autoSaved.bgSettings) Object.assign(bgSettings, autoSaved.bgSettings);
    active = autoSaved.active || 0;
  } else {
    slides = [createSlide('intro')];
    localStorage.removeItem('liquidGlassAutoSave');
  }
} else {
  slides = [createSlide('intro')];
}
renderActive();
renderGlowsList();
updateSlideWrapSize();
</script>
</body>
</html>
